{"title":"Migration WordPress en un clin d'oeil","link":"http://z720.net/blog/archives/2007/01/19/migration-wordpress-en-un-clin-doeil","pubDate":"Fri, 19 Jan 2007 18:43:30 +0000","dc:creator":"seb","guid":{"_":"http://v05.z720.net/blog/archives/2007/01/19/migration-wordpress-en-un-clin-doeil","$":{"isPermaLink":"false"}},"description":"","content:encoded":"Les versions de WordPress pleuvent en ce moment, la 2.0.7 pour des raisons de sécurité, la 2.1 en <a href=\"http://fr.wikipedia.org/wiki/Release_Candidate\">Release Candidate</a>. Mais la question la plus importante c'est comment déployer WordPress à chaque nouvelle version ? Quelle est la meilleur solution pour un site productif ? Par site productif, j'entends bien évidement un site accessible à des utilisateurs, ça n'a aucun rapport avec le contenu ou la fréquence de mise à jour...\r\n\r\n<!--more-->\r\n<h2><a href=\"#bourrin\" title=\"bourrin\" name=\"bourrin\">La méthode bourrin</a></h2>\r\nIl existe une méthode qui a fait ses preuves depuis de nombreuses années, à l'époque où peu de sites n'utilisaient de langages tels que PHP. Charger les fichiers à mettre à jour via votre client FTP favoris en remplaçant les anciens. Le problème c'est que le temps de transfert n'est toujours pas immédiat. Donc pendant que vous allez transférer vos fichiers, vos utilisateurs vont utiliser une application avec des bouts de code de versions différentes et là c'est le drame. Soit vous avez de la chance et tout fonctionne, soit le site plante avec une erreur PHP et votre visiteur vous prend pour un charlot, soit tout semble fonctionner pour lui et vos données deviennent incohérentes dans la base. Bref ce n'est pas la meilleur solution si vous avez un peu de trafic sur votre site. Sinon utilisez la plage de 2 heures lorsque personne ne visite votre site (souvent entre 2h et 4h du matin).\r\n<h2><a href=\"#malin\" title=\"malin\" name=\"malin\">La méthode dérangement</a></h2>\r\nUne autre méthode consiste à rediriger toutes les visites vers une page indiquant que pour des raisons techniques et/ou de maintenance le site est indisponible pendant quelques temps, le temps pour vous de mettre à jour tous les scripts, de mettre à jour la base de données et de vérifier que tout s'est bien passé. Malheureusement pendant ce temps, les visiteurs peuvent se décourager et ne pas revenir si le temps de maintenance est trop long ce qui est souvent le cas pour les visites depuis un moteur de recherche.\r\n<h2><a href=\"#bon\" title=\"bon\" name=\"bon\">La méthode transparente</a></h2>\r\nLa méthode que je vous propose devrait vous permettre de réduire considérablement le temps d'indisponibilité lors d'une mise à jour majeure.\r\n\r\nLa première chose à faire est de tester la nouvelle version en local pour s'assurer que tout va fonctionner. C'est évident mais comme ça va sans dire, c'est toujours mieux en le disant. C'est la phase de qualification (pour les pros).\r\n\r\nProcédure de déploiement d'une nouvelle version de WordPress :\r\n<ol>\r\n\t<li>Préparation (en local):\r\n<ol>\r\n\t<li>Placer la nouvelle version dans un répertoire spécifique par exemple dans v2</li>\r\n\t<li>Chargez votre thème dans le dossier v2/wp-content/themes ainsi que vos plugins dans v2/wp-content/plugins</li>\r\n\t<li>Chargez le fichier de localisation si vous n'utilisez pas WordPress en anglais. Pensez à prendre le fichier de localisation correspondant à la version que vous déployez.</li>\r\n\t<li>Chargez le contenu de vos uploads (wp-content/uploads) si vous n'avez pas déplacer vos upload ailleurs.</li>\r\n\t<li>Testez</li>\r\n\t<li>Chargez le fichier wp-config.php de la version précédente dans le dossier v2 pour récupérer le paramétrage de base de données et de localisation.</li>\r\n</ol>\r\n</li>\r\n\t<li>Déploiement (sur votre serveur)\r\n<ol>\r\n\t<li>Chargez le contenu de votre répertoire v2 à l'endroit où votre site doit se situer. A la racine du domaine si votre site est accessible directement depuis le domaine, dans le répertoire \"blog\" si WordPress est accessible via une adresse du type : http://votredomaine/blog/.</li>\r\n\t<li>Connectez-vous à l'interface d'administration de la version précédente et modifiez dans les options générales l'adresse WordPress  : il suffit de reprendre l'adresse du blog et de coller à la fin le nom du répertoire de la nouvelle version (ici v2)</li>\r\n\t<li>Préparez en local un fichier index.php qui contient le code suivant :\r\n<pre><code class=\"php\">&lt;?php /* Short and sweet */\r\ndefine('WP_USE_THEMES', true);\r\nrequire('./v2/wp-blog-header.php');\r\n?&gt;</code></pre>\r\nv2 doit correspondre au nom du répertoire qui contient la nouvelle version.</li>\r\n</ol>\r\n</li>\r\n\t<li>Bascule\r\n<ol>\r\n\t<li>Connectez-vous à l'interface d'administration de la nouvelle version pour mettre à jour la base de données</li>\r\n\t<li>Chargez le fichier index.php de l'étape 2 dans le dossier père de la nouvelle version</li>\r\n</ol>\r\n</li>\r\n</ol>\r\nC'est fini. De plus de cette façon, vous avez placé la nouvelle version wordpress dans son propre répertoire ce qui a pour vertu de l'isoler du reste de votre site. Avantage : seule l'étape 3 étant cruciale, vous pouvez préparez les autres étapes sur des mois.\r\n\r\nVous me direz qu'entre les étapes 3.1 et 3.2, vous allez vous retrouvé dans la situation <a href=\"#bourrin\">de la méthode bourrin</a> où la version précédente manipule un modèle de données différent de celui pour lequel elle a été construite. Certes rien ne vous empêche de passer par l'astuce du <a href=\"#malin\">malin</a> et de rediriger vos visiteurs vers un page de maintenance en indiquant de revenir dans la seconde, mais le temps de bascule est réduit à son minimum. Cette opération ne doit pas vous prendre plus de quelques secondes, soit le temps de passer de votre navigateur à votre client FTP.\r\n\r\nA moins que vous ne fassiez cette opération depuis une ligne GSM...","excerpt:encoded":"","wp:post_id":"210","wp:post_date":"2007-01-19 19:43:30","wp:post_date_gmt":"2007-01-19 18:43:30","wp:comment_status":"closed","wp:ping_status":"closed","wp:post_name":"migration-wordpress-en-un-clin-doeil","wp:status":"publish","wp:post_parent":"0","wp:menu_order":"0","wp:post_type":"post","wp:post_password":"","wp:is_sticky":"0","category":[{"_":"Développement","$":{"domain":"category","nicename":"developpement"}},{"_":"Web","$":{"domain":"category","nicename":"web"}},{"_":"WordPress","$":{"domain":"category","nicename":"wordpress"}}],"wp:comment":[{"wp:comment_id":["1032"],"wp:comment_author":["Seb"],"wp:comment_author_email":["blog@z720.net"],"wp:comment_author_url":["http://v05.z720.net/blog"],"wp:comment_author_IP":["62.147.180.94"],"wp:comment_date":["2007-06-06 20:15:17"],"wp:comment_date_gmt":["2007-06-06 19:15:17"],"wp:comment_content":["1. Il ne fallait pas créer une seconde base.\r\n\r\n2. C'est un problème d'auto increment dans la table\r\n\r\n3. En ne gardant qu'une seule base, ces opérations ne sont pas nécessaires"],"wp:comment_approved":["1"],"wp:comment_type":[""],"wp:comment_parent":["0"],"wp:comment_user_id":["1"]},{"wp:comment_id":["1033"],"wp:comment_author":["bmzoom"],"wp:comment_author_email":["bmil@free.fr"],"wp:comment_author_url":["http://bmil.free.fr/blog/"],"wp:comment_author_IP":["82.64.136.162"],"wp:comment_date":["2007-06-06 22:43:01"],"wp:comment_date_gmt":["2007-06-06 21:43:01"],"wp:comment_content":["Un dernier post qui n'a pas d'écho sur le forum de wp ( de ' ouf ' ):\r\n\r\nhttp://www.wordpress-fr.net/support/sujet-6283-flux-rss"],"wp:comment_approved":["1"],"wp:comment_type":[""],"wp:comment_parent":["0"],"wp:comment_user_id":["0"]},{"wp:comment_id":["1028"],"wp:comment_author":["Seb"],"wp:comment_author_email":["blog@z720.net"],"wp:comment_author_url":["http://v05.z720.net/blog"],"wp:comment_author_IP":["62.147.180.94"],"wp:comment_date":["2007-06-06 05:58:26"],"wp:comment_date_gmt":["2007-06-06 04:58:26"],"wp:comment_content":["Effectivement, s'il s'agit d'une simple mise à jour de l'applicatif WordPress. Ecraser les fichiers par FTP est souvent suffisant.\r\n<a href=#bourrin\" rel=\"nofollow\">C'est la méthode 1</a> et elle marche.\r\n\r\nPour la mise à jour automatique, je ne sais pas mais je me méfie de ce qui est automatique."],"wp:comment_approved":["1"],"wp:comment_type":[""],"wp:comment_parent":["0"],"wp:comment_user_id":["1"]},{"wp:comment_id":["1029"],"wp:comment_author":["bmzoom"],"wp:comment_author_email":["bmil@free.fr"],"wp:comment_author_url":["http://bmil.free.fr/blog/"],"wp:comment_author_IP":["82.250.129.125"],"wp:comment_date":["2007-06-06 14:31:07"],"wp:comment_date_gmt":["2007-06-06 13:31:07"],"wp:comment_content":["Le passage par ftp d'une version 2.0.xx vers 2.2 , s'est bien passé .\r\nAvant que le blog s'affiche il y a eu une maj de la base et le résultat est parfait .\r\n\r\nJ'ai maintenant 2 blog en version 2.2 , et comment migrer la base , du plus complet vers le vide\r\n\r\n- les pages et articles\r\n- la blogliste\r\n\r\nJ'ai 2 bases"],"wp:comment_approved":["1"],"wp:comment_type":[""],"wp:comment_parent":["0"],"wp:comment_user_id":["0"]},{"wp:comment_id":["1030"],"wp:comment_author":["bmzoom"],"wp:comment_author_email":["bmil@free.fr"],"wp:comment_author_url":["http://bmil.free.fr/blog/"],"wp:comment_author_IP":["82.250.129.125"],"wp:comment_date":["2007-06-06 14:48:33"],"wp:comment_date_gmt":["2007-06-06 13:48:33"],"wp:comment_content":["J'ai cette erreur sql :\r\n\r\nrequête SQL : \r\n\r\nINSERT INTO wp_categories\r\nVALUES ( 1, 'Non classÃ©', 'non-classe', '', 0, 0, 0, 0, 0 )\r\n\r\nMySQL a répondu:\r\n#1062 - Duplicate entry '1' for key 1"],"wp:comment_approved":["1"],"wp:comment_type":[""],"wp:comment_parent":["0"],"wp:comment_user_id":["0"]},{"wp:comment_id":["1031"],"wp:comment_author":["bmzoom"],"wp:comment_author_email":["bmil@free.fr"],"wp:comment_author_url":["http://bmil.free.fr/blog/"],"wp:comment_author_IP":["82.64.136.162"],"wp:comment_date":["2007-06-06 17:12:29"],"wp:comment_date_gmt":["2007-06-06 16:12:29"],"wp:comment_content":["Le passage d'une base vers l'autre a réussi avec un export sql :\r\n\r\n- nouveau prefix de table\r\n- recherche / remplacer blog1/ par blog2/ (*)\r\n\r\nLa sidebar de blog2 renvoyait sur blog1 et impossible de se connecter à blog2\r\n\r\nIl a fallu retoucher à la main dans la table wp_options , l'adresse fixe du blog (*) , qui n'est pas passé ( pas de / codé )\r\n\r\nDonc finition avec phpmyadmin à la main . La base de wp 2.2 a malgré tout atteint une très bonne fiabilité ."],"wp:comment_approved":["1"],"wp:comment_type":[""],"wp:comment_parent":["0"],"wp:comment_user_id":["0"]},{"wp:comment_id":["1027"],"wp:comment_author":["bmzoom"],"wp:comment_author_email":["bmil@free.fr"],"wp:comment_author_url":["http://bmil.free.fr/blog/"],"wp:comment_author_IP":["82.250.129.125"],"wp:comment_date":["2007-06-05 21:27:11"],"wp:comment_date_gmt":["2007-06-05 20:27:11"],"wp:comment_content":["Je n'ai pas encore fait la bascule entre 2 versions de wordpress , mais j'ai lu :\r\n\r\n- que avec le ftp  il fallait copier les nouveaux fichiers sur les anciens en gardant la base \r\n- est ce correct ?\r\n- qu'une mise à jour automatique est possible depuis la version 2.1\r\n\r\nJ'ai la 2.2 et je ne sais pas encore ce qui est le mieux pour la suite ...\r\n\r\n@+"],"wp:comment_approved":["1"],"wp:comment_type":[""],"wp:comment_parent":["0"],"wp:comment_user_id":["0"]},{"wp:comment_id":["1025"],"wp:comment_author":["bmzoom"],"wp:comment_author_email":["bmil@free.fr"],"wp:comment_author_url":["http://bmil.free.fr/blog/"],"wp:comment_author_IP":["82.254.26.139"],"wp:comment_date":["2007-06-05 11:14:03"],"wp:comment_date_gmt":["2007-06-05 10:14:03"],"wp:comment_content":["Si j'ai bien compris :\r\n\r\n- l'ancien blog va fonctionner avec les templates du nouveau\r\n\r\n- c'est la connexion au nouveau blog et la mise à jour de la base , qu'il faut préciser , il n'y a pas encore eu d'installation du nouveau\r\nblog ( que des transfert FTP )\r\n\r\n- comment a lieu cette connexion ?\r\n\r\n@+"],"wp:comment_approved":["1"],"wp:comment_type":[""],"wp:comment_parent":["0"],"wp:comment_user_id":["0"]},{"wp:comment_id":["1026"],"wp:comment_author":["Seb"],"wp:comment_author_email":["blog@z720.net"],"wp:comment_author_url":["http://v05.z720.net/blog"],"wp:comment_author_IP":["194.75.220.61"],"wp:comment_date":["2007-06-05 11:53:47"],"wp:comment_date_gmt":["2007-06-05 10:53:47"],"wp:comment_content":["L'ancien blog ne peut a priori jamais tourné avec les templates du nouveau.\r\nSoit ça tourne dans une version, soit dans l'autre (en terme d'applicatif). Il s'agit uniquement des données qui sont utilisées (articles, pages, options...)\r\n\r\nIl n'y a pas d'installation du nouveau blog, puisque l'on utilise la même base de données et les mêmes tables.\r\n\r\nL'activation de la nouvelle version se fait à la dernière étape, en chargeant le bon fichier index.php car c'est lui qui indique quelle version de WordPress il faut exécuter."],"wp:comment_approved":["1"],"wp:comment_type":[""],"wp:comment_parent":["0"],"wp:comment_user_id":["1"]}],"template":"v05/post.jade","filename":"index.html"}